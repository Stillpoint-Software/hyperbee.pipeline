name: Test Report
run-name: Generate Test Report for workflow ${{ github.event.workflow_run.name }} run ${{ github.event.workflow_run.run_number }} branch ${{ github.event.workflow_run.head_branch }}

on:
  workflow_run:
    workflows: [ "Test" ]
    types: [ completed ]

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.set_branch.outputs.branch_name }}
    steps:
      - id: set_branch
        run: echo "branch_name=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"

  report-main:
    needs: discover
    if: ${{ needs.discover.outputs.branch_name == 'main' }}
    uses: Stillpoint-Software/shared-workflows/.github/workflows/test.yml@main
    with:
      artifact_name:     test-results
      test_report_name:  Unit Tests
      path:              "*.trx"

  report-develop:
    needs: discover
    if: ${{ needs.discover.outputs.branch_name == 'develop' }}
    uses: Stillpoint-Software/shared-workflows/.github/workflows/test.yml@develop
    with:
      artifact_name:     test-results
      test_report_name:  Unit Tests
      path:              "*.trx"

  report-other:
    needs: discover
    if: ${{ needs.discover.outputs.branch_name != 'main' && needs.discover.outputs.branch_name != 'develop' }}
    uses: Stillpoint-Software/shared-workflows/.github/workflows/test.yml@main   # or @develop, or skip entirely
    with:
      artifact_name:     test-results
      test_report_name:  Unit Tests
      path:              "*.trx"
