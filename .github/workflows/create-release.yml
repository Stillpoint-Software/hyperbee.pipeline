name: Prepare Release & Publish Package

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: "Branch or tag to release from"
        type: choice
        options: [ main, master, develop ]
        default: main
        required: true
      increment:
        description: "Version bump"
        type: choice
        options: [ major, minor, patch ]
        default: patch
        required: true

permissions:
  contents: write
  pull-requests: write
  packages: write

jobs:
  validate_branch:
    runs-on: ubuntu-latest
    outputs:
      version_json_path: ${{ steps.locate_version.outputs.file }}
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ inputs.target_branch }}

      - name: Ensure target branch exists
        run: |
          if ! git rev-parse --verify --quiet "refs/heads/${{ inputs.target_branch }}"; then
            echo "::error::Ref '${{ inputs.target_branch }}' not found."
            exit 1
          fi

      - name: Locate version.json
        id: locate_version
        shell: bash
        run: |
          REL_PATH=$(git ls-files --full-name '*version.json' | head -n1)
          if [[ -z "$REL_PATH" ]]; then
            REL_PATH=$(find . -type f -name version.json | head -n1 | sed 's|^\./||')
          fi
          if [[ -z "$REL_PATH" ]]; then
            echo "::error::version.json not found on branch '${{ inputs.target_branch }}'."
            exit 1
          fi
          echo "file=$GITHUB_WORKSPACE/$REL_PATH" >> "$GITHUB_OUTPUT"

  prepare-main:
    needs: validate_branch
    if: ${{ inputs.target_branch == 'main' || inputs.target_branch == 'master' }}
    uses: Stillpoint-Software/shared-workflows/.github/workflows/nbgv_prepare_release.yml@main
    with:
      target_branch:     ${{ inputs.target_branch }}
      increment:         ${{ inputs.increment }}
      version_file_path: ${{ needs.validate_branch.outputs.version_json_path }}
    secrets: inherit

  prepare-develop:
    needs: validate_branch
    if: ${{ inputs.target_branch == 'develop' }}
    uses: Stillpoint-Software/shared-workflows/.github/workflows/nbgv_prepare_release.yml@develop
    with:
      target_branch:     ${{ inputs.target_branch }}
      increment:         ${{ inputs.increment }}
      version_file_path: ${{ needs.validate_branch.outputs.version_json_path }}
    secrets: inherit

  publish-main:
    needs: prepare-main
    if: ${{ inputs.target_branch == 'main' || inputs.target_branch == 'master' }}
    uses: Stillpoint-Software/shared-workflows/.github/workflows/nbgv_dotnet_pack.yml@main
    with:
      checkout_ref:         ${{ needs.prepare-main.outputs.release_branch }}
      build_configuration:  Release
      push_after_pack:      true
      force_dev_prerelease: false
    secrets:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

  publish-develop:
    needs: prepare-develop
    if: ${{ inputs.target_branch == 'develop' }}
    uses: Stillpoint-Software/shared-workflows/.github/workflows/nbgv_dotnet_pack.yml@develop
    with:
      checkout_ref:         ${{ needs.prepare-develop.outputs.release_branch }}
      build_configuration:  Develop
      push_after_pack:      true
      force_dev_prerelease: true
    secrets:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
